service: vyaparai-api

frameworkVersion: '3'

provider:
  name: aws
  runtime: python3.11
  region: ap-south-1
  stage: ${opt:stage, 'dev'}
  memorySize: 1024
  timeout: 30
  logRetentionInDays: 14
  
  # Environment variables
  environment:
    ENVIRONMENT: ${self:provider.stage}
    POWERTOOLS_SERVICE_NAME: vyaparai-api
    POWERTOOLS_METRICS_NAMESPACE: VyaparAI
    LOG_LEVEL: INFO
    RDS_DATABASE: vyaparai
    RDS_PORT: 5432
    
  # IAM role permissions
  iam:
    role:
      statements:
        # DynamoDB permissions
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:DescribeStream
            - dynamodb:GetRecords
            - dynamodb:GetShardIterator
            - dynamodb:ListStreams
          Resource:
            - !GetAtt OrdersTable.Arn
            - !GetAtt SessionsTable.Arn
            - !GetAtt RateLimitsTable.Arn
            - !GetAtt StoresTable.Arn
            - !GetAtt ProductsTable.Arn
            - !GetAtt MetricsTable.Arn
            - !Sub "${OrdersTable.Arn}/index/*"
            - !Sub "${SessionsTable.Arn}/index/*"
            - !Sub "${RateLimitsTable.Arn}/index/*"
            - !Sub "${StoresTable.Arn}/index/*"
            - !Sub "${ProductsTable.Arn}/index/*"
            - !Sub "${MetricsTable.Arn}/index/*"
            - !GetAtt OrdersTable.StreamArn
        
        # RDS permissions
        - Effect: Allow
          Action:
            - rds:DescribeDBInstances
            - rds:DescribeDBClusters
          Resource: "*"
        
        # ElastiCache permissions
        - Effect: Allow
          Action:
            - elasticache:DescribeCacheClusters
            - elasticache:DescribeCacheSubnetGroups
          Resource: "*"
        
        # S3 permissions
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource: !Sub "${StaticAssetsBucket.Arn}/*"
        
        # Secrets Manager permissions
        - Effect: Allow
          Action:
            - secretsmanager:GetSecretValue
          Resource: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:vyaparai/*"
        
        # SSM Parameter Store permissions
        - Effect: Allow
          Action:
            - ssm:GetParameter
            - ssm:GetParameters
            - ssm:GetParametersByPath
          Resource: !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/vyaparai/*"
        
        # CloudWatch Logs permissions
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"
        
        # X-Ray permissions
        - Effect: Allow
          Action:
            - xray:PutTraceSegments
            - xray:PutTelemetryRecords
          Resource: "*"

  # VPC configuration for RDS and ElastiCache
  vpc:
    securityGroupIds:
      - !Ref LambdaSecurityGroup
    subnetIds:
      - !Ref PrivateSubnet1
      - !Ref PrivateSubnet2

  # API Gateway configuration
  apiGateway:
    shouldStartNameWithService: true
    binaryMediaTypes:
      - '*/*'
    cors:
      origin: '*'
      headers:
        - Content-Type
        - X-Amz-Date
        - Authorization
        - X-Api-Key
        - X-Amz-Security-Token
        - X-Amz-User-Agent
        - X-Request-ID
      allowCredentials: false

  # Lambda configuration
  lambdaHashingVersion: 20201221

# Custom variables
custom:
  # Domain configuration
  domainName: api.vyaparai.com
  certificateName: '*.vyaparai.com'
  
  # Environment-specific settings
  stages:
    dev:
      domainName: dev-api.vyaparai.com
      memorySize: 512
      timeout: 30
    staging:
      domainName: staging-api.vyaparai.com
      memorySize: 1024
      timeout: 30
    prod:
      domainName: api.vyaparai.com
      memorySize: 2048
      timeout: 60
  
  # Current stage settings
  currentStage: ${self:custom.stages.${self:provider.stage}}
  
  # Table names
  tableNames:
    orders: vyaparai-orders-${self:provider.stage}
    sessions: vyaparai-sessions-${self:provider.stage}
    rate_limits: vyaparai-rate-limits-${self:provider.stage}
    stores: vyaparai-stores-${self:provider.stage}
    products: vyaparai-products-${self:provider.stage}
    metrics: vyaparai-metrics-${self:provider.stage}
  
  # Bucket names
  bucketNames:
    staticAssets: vyaparai-static-${self:provider.stage}
    logs: vyaparai-logs-${self:provider.stage}

# Functions
functions:
  # Main API handler
  api:
    handler: app.main.handler
    events:
      - http:
          path: /{proxy+}
          method: ANY
          cors: true
          authorizer: none
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
      DYNAMODB_SESSIONS_TABLE: ${self:custom.tableNames.sessions}
      DYNAMODB_RATE_LIMITS_TABLE: ${self:custom.tableNames.rate_limits}
      DYNAMODB_STORES_TABLE: ${self:custom.tableNames.stores}
      DYNAMODB_PRODUCTS_TABLE: ${self:custom.tableNames.products}
      DYNAMODB_METRICS_TABLE: ${self:custom.tableNames.metrics}
      REDIS_ENDPOINT: !GetAtt RedisCluster.RedisEndpoint.Address
      REDIS_PORT: !GetAtt RedisCluster.RedisEndpoint.Port
      S3_STATIC_BUCKET: ${self:custom.bucketNames.staticAssets}
      SECRETS_PREFIX: /vyaparai/${self:provider.stage}
      RDS_HOSTNAME: !GetAtt AnalyticsDB.Endpoint.Address
      RDS_USERNAME: !GetAtt AnalyticsDB.MasterUsername
      RDS_PASSWORD: !GetAtt AnalyticsDB.MasterUserPassword
    layers:
      - !Ref DependenciesLayer
    reservedConcurrency: 100
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-api

  # Health check function
  health:
    handler: app.handlers.health.handler
    events:
      - http:
          path: /health
          method: GET
          cors: true
    environment:
      ENVIRONMENT: ${self:provider.stage}
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-health

  # Order processing function
  processOrder:
    handler: app.handlers.orders.process_order
    events:
      - http:
          path: /api/v1/orders/process
          method: POST
          cors: true
          request:
            schemas:
              application/json: ${file(./schemas/process-order-request.json)}
          response:
            headers:
              Access-Control-Allow-Origin: "'*'"
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
      DYNAMODB_SESSIONS_TABLE: ${self:custom.tableNames.sessions}
      DYNAMODB_RATE_LIMITS_TABLE: ${self:custom.tableNames.rate_limits}
      REDIS_ENDPOINT: !GetAtt RedisCluster.RedisEndpoint.Address
      REDIS_PORT: !GetAtt RedisCluster.RedisEndpoint.Port
      RDS_HOSTNAME: !GetAtt AnalyticsDB.Endpoint.Address
      RDS_USERNAME: !GetAtt AnalyticsDB.MasterUsername
      RDS_PASSWORD: !GetAtt AnalyticsDB.MasterUserPassword
    layers:
      - !Ref DependenciesLayer
    reservedConcurrency: 50
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-orders

  # Get order function
  getOrder:
    handler: app.handlers.orders.get_order
    events:
      - http:
          path: /api/v1/orders/{order_id}
          method: GET
          cors: true
          request:
            parameters:
              paths:
                order_id: true
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
    layers:
      - !Ref DependenciesLayer
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-orders

  # Confirm order function
  confirmOrder:
    handler: app.handlers.orders.confirm_order
    events:
      - http:
          path: /api/v1/orders/confirm/{order_id}
          method: POST
          cors: true
          request:
            parameters:
              paths:
                order_id: true
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
    layers:
      - !Ref DependenciesLayer
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-orders

  # Cancel order function
  cancelOrder:
    handler: app.handlers.orders.cancel_order
    events:
      - http:
          path: /api/v1/orders/{order_id}/cancel
          method: POST
          cors: true
          request:
            parameters:
              paths:
                order_id: true
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
    layers:
      - !Ref DependenciesLayer
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-orders

  # Order history function
  orderHistory:
    handler: app.handlers.orders.get_history
    events:
      - http:
          path: /api/v1/orders/history/{customer_phone}
          method: GET
          cors: true
          request:
            parameters:
              paths:
                customer_phone: true
              querystrings:
                page: false
                page_size: false
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
    layers:
      - !Ref DependenciesLayer
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-orders

  # Analytics function
  analytics:
    handler: app.handlers.analytics.get_analytics
    events:
      - http:
          path: /api/v1/analytics/{store_id}
          method: GET
          cors: true
          request:
            parameters:
              paths:
                store_id: true
    environment:
      RDS_HOSTNAME: !GetAtt AnalyticsDB.Endpoint.Address
      RDS_USERNAME: !GetAtt AnalyticsDB.MasterUsername
      RDS_PASSWORD: !GetAtt AnalyticsDB.MasterUserPassword
    layers:
      - !Ref DependenciesLayer
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-analytics

  # Metrics function
  metrics:
    handler: app.handlers.orders.get_metrics
    events:
      - http:
          path: /api/v1/orders/metrics
          method: GET
          cors: true
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
      DYNAMODB_METRICS_TABLE: ${self:custom.tableNames.metrics}
      REDIS_ENDPOINT: !GetAtt RedisCluster.RedisEndpoint.Address
      REDIS_PORT: !GetAtt RedisCluster.RedisEndpoint.Port
    layers:
      - !Ref DependenciesLayer
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-metrics

  # DynamoDB Stream Processor
  streamProcessor:
    handler: app.database.stream_processor.process_order_stream
    events:
      - stream:
          type: dynamodb
          arn: !GetAtt OrdersTable.StreamArn
          batchSize: 10
          startingPosition: LATEST
          maximumRetryAttempts: 3
    environment:
      RDS_HOSTNAME: !GetAtt AnalyticsDB.Endpoint.Address
      RDS_USERNAME: !GetAtt AnalyticsDB.MasterUsername
      RDS_PASSWORD: !GetAtt AnalyticsDB.MasterUserPassword
    layers:
      - !Ref DependenciesLayer
    reservedConcurrency: 10
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-stream-processor

  # WhatsApp webhook function
  webhookWhatsApp:
    handler: app.handlers.webhooks.whatsapp_handler
    events:
      - http:
          path: /api/v1/orders/webhooks/whatsapp
          method: POST
          cors: true
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
      DYNAMODB_SESSIONS_TABLE: ${self:custom.tableNames.sessions}
      WHATSAPP_VERIFY_TOKEN: ${ssm:/vyaparai/${self:provider.stage}/whatsapp/verify_token}
    layers:
      - !Ref DependenciesLayer
    reservedConcurrency: 20
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-webhooks

  # RCS webhook function
  webhookRCS:
    handler: app.handlers.webhooks.rcs_handler
    events:
      - http:
          path: /api/v1/orders/webhooks/rcs
          method: POST
          cors: true
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
      DYNAMODB_SESSIONS_TABLE: ${self:custom.tableNames.sessions}
    layers:
      - !Ref DependenciesLayer
    reservedConcurrency: 20
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-webhooks

  # SMS webhook function
  webhookSMS:
    handler: app.handlers.webhooks.sms_handler
    events:
      - http:
          path: /api/v1/orders/webhooks/sms
          method: POST
          cors: true
    environment:
      DYNAMODB_ORDERS_TABLE: ${self:custom.tableNames.orders}
      DYNAMODB_SESSIONS_TABLE: ${self:custom.tableNames.sessions}
    layers:
      - !Ref DependenciesLayer
    reservedConcurrency: 20
    tags:
      Environment: ${self:provider.stage}
      Service: vyaparai-webhooks

# Layers
layers:
  dependencies:
    path: layer
    description: Python dependencies for VyaparAI
    compatibleRuntimes:
      - python3.11
    retain: true

# Resources
resources:
  Resources:
    # DynamoDB Tables
    OrdersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.orders}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: sk
            AttributeType: S
          - AttributeName: gsi1pk
            AttributeType: S
          - AttributeName: gsi1sk
            AttributeType: S
          - AttributeName: gsi2pk
            AttributeType: S
          - AttributeName: gsi2sk
            AttributeType: S
          - AttributeName: gsi3pk
            AttributeType: S
          - AttributeName: gsi3sk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
          - AttributeName: sk
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: gsi1pk
                KeyType: HASH
              - AttributeName: gsi1sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI2
            KeySchema:
              - AttributeName: gsi2pk
                KeyType: HASH
              - AttributeName: gsi2sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI3
            KeySchema:
              - AttributeName: gsi3pk
                KeyType: HASH
              - AttributeName: gsi3sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        StreamSpecification:
          StreamEnabled: true
          StreamViewType: NEW_AND_OLD_IMAGES
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-orders
          - Key: TableType
            Value: hot-path

    SessionsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.sessions}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: gsi1pk
            AttributeType: S
          - AttributeName: gsi1sk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: gsi1pk
                KeyType: HASH
              - AttributeName: gsi1sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-sessions
          - Key: TableType
            Value: session-cache

    RateLimitsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.rate_limits}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: sk
            AttributeType: S
          - AttributeName: gsi1pk
            AttributeType: S
          - AttributeName: gsi1sk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
          - AttributeName: sk
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: gsi1pk
                KeyType: HASH
              - AttributeName: gsi1sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-rate-limits
          - Key: TableType
            Value: rate-limiting

    StoresTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.stores}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: gsi1pk
            AttributeType: S
          - AttributeName: gsi1sk
            AttributeType: S
          - AttributeName: gsi2pk
            AttributeType: S
          - AttributeName: gsi2sk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: gsi1pk
                KeyType: HASH
              - AttributeName: gsi1sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI2
            KeySchema:
              - AttributeName: gsi2pk
                KeyType: HASH
              - AttributeName: gsi2sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-stores
          - Key: TableType
            Value: master-data

    ProductsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.products}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: sk
            AttributeType: S
          - AttributeName: gsi1pk
            AttributeType: S
          - AttributeName: gsi1sk
            AttributeType: S
          - AttributeName: gsi2pk
            AttributeType: S
          - AttributeName: gsi2sk
            AttributeType: S
          - AttributeName: gsi3pk
            AttributeType: S
          - AttributeName: gsi3sk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
          - AttributeName: sk
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: gsi1pk
                KeyType: HASH
              - AttributeName: gsi1sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI2
            KeySchema:
              - AttributeName: gsi2pk
                KeyType: HASH
              - AttributeName: gsi2sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          - IndexName: GSI3
            KeySchema:
              - AttributeName: gsi3pk
                KeyType: HASH
              - AttributeName: gsi3sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-products
          - Key: TableType
            Value: catalog

    MetricsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.tableNames.metrics}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: pk
            AttributeType: S
          - AttributeName: sk
            AttributeType: S
          - AttributeName: gsi1pk
            AttributeType: S
          - AttributeName: gsi1sk
            AttributeType: S
        KeySchema:
          - AttributeName: pk
            KeyType: HASH
          - AttributeName: sk
            KeyType: RANGE
        GlobalSecondaryIndexes:
          - IndexName: GSI1
            KeySchema:
              - AttributeName: gsi1pk
                KeyType: HASH
              - AttributeName: gsi1sk
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        PointInTimeRecoverySpecification:
          PointInTimeRecoveryEnabled: true
        SSESpecification:
          SSEEnabled: true
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-metrics
          - Key: TableType
            Value: metrics

    # RDS PostgreSQL Instance
    AnalyticsDB:
      Type: AWS::RDS::DBInstance
      Properties:
        DBInstanceIdentifier: vyaparai-analytics-${self:provider.stage}
        DBInstanceClass: ${self:custom.currentStage.memorySize == 2048 ? 'db.t3.medium' : 'db.t3.micro'}
        Engine: postgres
        EngineVersion: '15.4'
        AllocatedStorage: ${self:custom.currentStage.memorySize == 2048 ? '100' : '20'}
        MaxAllocatedStorage: ${self:custom.currentStage.memorySize == 2048 ? '500' : '100'}
        StorageType: gp3
        StorageEncrypted: true
        DBName: vyaparai
        MasterUsername: vyaparai_admin
        MasterUserPassword: !Sub '{{resolve:secretsmanager:vyaparai/rds/${self:provider.stage}/credentials:SecretString:password}}'
        Port: '5432'
        VPCSecurityGroups:
          - !Ref RDSSecurityGroup
        DBSubnetGroupName: !Ref DBSubnetGroup
        PubliclyAccessible: false
        MultiAZ: ${self:custom.currentStage.memorySize == 2048 ? 'true' : 'false'}
        BackupRetentionPeriod: ${self:custom.currentStage.memorySize == 2048 ? '30' : '7'}
        BackupWindow: '03:00-04:00'
        MaintenanceWindow: 'sun:04:00-sun:05:00'
        EnableCloudwatchLogsExports:
          - postgresql
        MonitoringInterval: 60
        MonitoringRoleArn: !GetAtt RDSMonitoringRole.Arn
        PerformanceInsightsEnabled: true
        PerformanceInsightsRetentionPeriod: ${self:custom.currentStage.memorySize == 2048 ? '7' : '3'}
        DeletionProtection: ${self:custom.currentStage.memorySize == 2048 ? 'true' : 'false'}
        SkipFinalSnapshot: ${self:custom.currentStage.memorySize == 2048 ? 'false' : 'true'}
        FinalDBSnapshotIdentifier: ${self:custom.currentStage.memorySize == 2048 ? 'vyaparai-analytics-${self:provider.stage}-final' : ''}
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-analytics
          - Key: DatabaseType
            Value: analytics

    # RDS Subnet Group
    DBSubnetGroup:
      Type: AWS::RDS::DBSubnetGroup
      Properties:
        DBSubnetGroupName: vyaparai-rds-subnet-group-${self:provider.stage}
        DBSubnetGroupDescription: Subnet group for VyaparAI RDS
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-rds

    # RDS Security Group
    RDSSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security group for VyaparAI RDS
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 5432
            ToPort: 5432
            SourceSecurityGroupId: !Ref LambdaSecurityGroup
        SecurityGroupEgress:
          - IpProtocol: -1
            CidrIp: 0.0.0.0/0
        Tags:
          - Key: Name
            Value: vyaparai-rds-sg-${self:provider.stage}

    # RDS Monitoring Role
    RDSMonitoringRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: vyaparai-rds-monitoring-${self:provider.stage}
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: monitoring.rds.amazonaws.com
              Action: sts:AssumeRole
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-rds

    # S3 Buckets
    StaticAssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.bucketNames.staticAssets}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldVersions
              Status: Enabled
              NoncurrentVersionExpirationInDays: 30
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-static

    LogsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.bucketNames.logs}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldLogs
              Status: Enabled
              ExpirationInDays: 90
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-logs

    # ElastiCache Redis Cluster
    RedisCluster:
      Type: AWS::ElastiCache::CacheCluster
      Properties:
        CacheNodeType: cache.t3.micro
        Engine: redis
        NumCacheNodes: 1
        Port: 6379
        VpcSecurityGroupIds:
          - !Ref RedisSecurityGroup
        CacheSubnetGroupName: !Ref RedisSubnetGroup
        PreferredMaintenanceWindow: sun:05:00-sun:09:00
        SnapshotRetentionLimit: 7
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-redis

    RedisSubnetGroup:
      Type: AWS::ElastiCache::SubnetGroup
      Properties:
        Description: Subnet group for VyaparAI Redis cluster
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2

    # Security Groups
    LambdaSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security group for VyaparAI Lambda functions
        VpcId: !Ref VPC
        SecurityGroupEgress:
          - IpProtocol: -1
            CidrIp: 0.0.0.0/0

    RedisSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security group for VyaparAI Redis cluster
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 6379
            ToPort: 6379
            SourceSecurityGroupId: !Ref LambdaSecurityGroup
        SecurityGroupEgress:
          - IpProtocol: -1
            CidrIp: 0.0.0.0/0

    # VPC Resources
    VPC:
      Type: AWS::EC2::VPC
      Properties:
        CidrBlock: 10.0.0.0/16
        EnableDnsHostnames: true
        EnableDnsSupport: true
        Tags:
          - Key: Name
            Value: vyaparai-vpc-${self:provider.stage}

    PublicSubnet1:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: 10.0.1.0/24
        AvailabilityZone: !Select [0, !GetAZs '']
        MapPublicIpOnLaunch: true
        Tags:
          - Key: Name
            Value: vyaparai-public-subnet-1-${self:provider.stage}

    PublicSubnet2:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: 10.0.2.0/24
        AvailabilityZone: !Select [1, !GetAZs '']
        MapPublicIpOnLaunch: true
        Tags:
          - Key: Name
            Value: vyaparai-public-subnet-2-${self:provider.stage}

    PrivateSubnet1:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: 10.0.3.0/24
        AvailabilityZone: !Select [0, !GetAZs '']
        Tags:
          - Key: Name
            Value: vyaparai-private-subnet-1-${self:provider.stage}

    PrivateSubnet2:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: 10.0.4.0/24
        AvailabilityZone: !Select [1, !GetAZs '']
        Tags:
          - Key: Name
            Value: vyaparai-private-subnet-2-${self:provider.stage}

    InternetGateway:
      Type: AWS::EC2::InternetGateway
      Properties:
        Tags:
          - Key: Name
            Value: vyaparai-igw-${self:provider.stage}

    AttachGateway:
      Type: AWS::EC2::VPCGatewayAttachment
      Properties:
        VpcId: !Ref VPC
        InternetGatewayId: !Ref InternetGateway

    PublicRouteTable:
      Type: AWS::EC2::RouteTable
      Properties:
        VpcId: !Ref VPC
        Tags:
          - Key: Name
            Value: vyaparai-public-rt-${self:provider.stage}

    PublicRoute:
      Type: AWS::EC2::Route
      DependsOn: AttachGateway
      Properties:
        RouteTableId: !Ref PublicRouteTable
        DestinationCidrBlock: 0.0.0.0/0
        GatewayId: !Ref InternetGateway

    PublicSubnet1RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        SubnetId: !Ref PublicSubnet1
        RouteTableId: !Ref PublicRouteTable

    PublicSubnet2RouteTableAssociation:
      Type: AWS::EC2::SubnetRouteTableAssociation
      Properties:
        SubnetId: !Ref PublicSubnet2
        RouteTableId: !Ref PublicRouteTable

    # Secrets Manager
    VyaparAISecrets:
      Type: AWS::SecretsManager::Secret
      Properties:
        Name: vyaparai/${self:provider.stage}/secrets
        Description: Secrets for VyaparAI ${self:provider.stage} environment
        SecretString: !Sub |
          {
            "GOOGLE_API_KEY": "your_google_api_key_here",
            "GOOGLE_TRANSLATE_API_KEY": "your_google_translate_key_here",
            "WHATSAPP_ACCESS_TOKEN": "your_whatsapp_token_here",
            "RCS_API_KEY": "your_rcs_api_key_here",
            "SMS_API_KEY": "your_sms_api_key_here"
          }
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: vyaparai-secrets

  Outputs:
    # API Gateway URL
    ApiGatewayUrl:
      Description: URL of the API Gateway
      Value: !Sub "https://${ApiGatewayRestApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}"
      Export:
        Name: !Sub "${AWS::StackName}-ApiGatewayUrl"

    # DynamoDB Tables
    OrdersTableName:
      Description: Name of the Orders DynamoDB table
      Value: !Ref OrdersTable
      Export:
        Name: !Sub "${AWS::StackName}-OrdersTableName"

    OrdersTableStreamArn:
      Description: Stream ARN of the Orders DynamoDB table
      Value: !GetAtt OrdersTable.StreamArn
      Export:
        Name: !Sub "${AWS::StackName}-OrdersTableStreamArn"

    SessionsTableName:
      Description: Name of the Sessions DynamoDB table
      Value: !Ref SessionsTable
      Export:
        Name: !Sub "${AWS::StackName}-SessionsTableName"

    RateLimitsTableName:
      Description: Name of the Rate Limits DynamoDB table
      Value: !Ref RateLimitsTable
      Export:
        Name: !Sub "${AWS::StackName}-RateLimitsTableName"

    StoresTableName:
      Description: Name of the Stores DynamoDB table
      Value: !Ref StoresTable
      Export:
        Name: !Sub "${AWS::StackName}-StoresTableName"

    ProductsTableName:
      Description: Name of the Products DynamoDB table
      Value: !Ref ProductsTable
      Export:
        Name: !Sub "${AWS::StackName}-ProductsTableName"

    MetricsTableName:
      Description: Name of the Metrics DynamoDB table
      Value: !Ref MetricsTable
      Export:
        Name: !Sub "${AWS::StackName}-MetricsTableName"

    # RDS Outputs
    RDSHostname:
      Description: RDS instance endpoint
      Value: !GetAtt AnalyticsDB.Endpoint.Address
      Export:
        Name: !Sub "${AWS::StackName}-RDSHostname"

    RDSPort:
      Description: RDS instance port
      Value: !GetAtt AnalyticsDB.Endpoint.Port
      Export:
        Name: !Sub "${AWS::StackName}-RDSPort"

    # Redis Endpoint
    RedisEndpoint:
      Description: Redis cluster endpoint
      Value: !GetAtt RedisCluster.RedisEndpoint.Address
      Export:
        Name: !Sub "${AWS::StackName}-RedisEndpoint"

    # S3 Buckets
    StaticAssetsBucketName:
      Description: Name of the static assets S3 bucket
      Value: !Ref StaticAssetsBucket
      Export:
        Name: !Sub "${AWS::StackName}-StaticAssetsBucketName"

    LogsBucketName:
      Description: Name of the logs S3 bucket
      Value: !Ref LogsBucket
      Export:
        Name: !Sub "${AWS::StackName}-LogsBucketName"

    # VPC
    VPCId:
      Description: VPC ID
      Value: !Ref VPC
      Export:
        Name: !Sub "${AWS::StackName}-VPCId"

    # Secrets
    SecretsArn:
      Description: ARN of the secrets in Secrets Manager
      Value: !Ref VyaparAISecrets
      Export:
        Name: !Sub "${AWS::StackName}-SecretsArn"

# Plugins
plugins:
  - serverless-python-requirements
  - serverless-domain-manager
  - serverless-offline

# Package configuration
package:
  exclude:
    - node_modules/**
    - .git/**
    - .gitignore
    - README.md
    - tests/**
    - .env
    - .env.*
    - *.pyc
    - __pycache__/**
    - .pytest_cache/**
    - .coverage
    - htmlcov/**
    - .mypy_cache/**
    - .ruff_cache/**
